@page "/map-basic"
@rendermode InteractiveServer
@inject ILogger<BasicMap> Logger
@inject IToastService ToastService
@inject IMapDataService DataService

<PageTitle>Basic Map</PageTitle>

<FluentLayout>
	<MapPageHeader Header="@header" HRefCode="@hRefCode">
		<FluentLabel>
            This example demonstrates how to set up a basic Azure Map using the Marqdouj.DotNet.AzureMaps library in a Blazor application.
			<br />
			The map is initialized to a specific camera position (Seattle, WA), with some common map controls.
            <br />
			Use the "Reset Map" button to reset the map to its initial state.
            <br />
			Click on a layer button to add that type of layer to the map.
		</FluentLabel>
	</MapPageHeader>

	<FluentToolbar>
        <FluentButton Disabled="@disabled" IconStart="@(new Icons.Regular.Size20.ArrowReset())" Title="Reset Map" OnClick="@ResetMap" />
        <FluentSpacer Width="8" />
        <FluentButton Disabled="@disabledGetLocation" IconStart="@(new Icons.Regular.Size20.GlobeSearch())" Title="Get Current Location" OnClick="@GetCurrentPosition" />
        <FluentSpacer Width="3" />
        <FluentButton Disabled="@disabledWatching" IconStart="@(new Icons.Regular.Size20.EyeTracking())" Title="Start Watch" OnClick="@(() => GeolocationWatch(true))" />
        <FluentButton Disabled="@disabledNotWatching" IconStart="@(new Icons.Regular.Size20.EyeTrackingOff())" Title="Stop Watch" OnClick="@(() => GeolocationWatch(false))" />
        <FluentSpacer Width="8" />
        @{
            foreach (var layerType in Enum.GetValues<MapLayerType>().Where(e => e != MapLayerType.Unknown))
            {
                <FluentButton Disabled="@disabled" IconStart="@(new Icons.Regular.Size20.Map())" Title="@(layerType.ToString())" OnClick="@(() => AddMapLayer(layerType))">
                    @layerType.ToString()
                </FluentButton>
            }
        }
    </FluentToolbar>

    <AzureMap OnCreateMapError="@OnCreatMapError"
              OnMapReady="@OnMapReady"
              OnGeolocationWatch="@OnGeolocationWatch"
              Controls="@MapHelpers.GetDefaultControls()"
              Options="@MapHelpers.GetDefaultCreateMapOptions()" />
</FluentLayout>

<FluentOverlay @bind-Visible="@overlay"
			   Transparent="false">
	<FluentProgressRing />
</FluentOverlay>

@code {
    private readonly string hRefCode = HRefCodeSource.Sandbox.CodeUrl("BasicMap.razor");
    private readonly string header = "Basic Map";
    private readonly MapOptionsSet options = MapHelpers.GetDefaultSetMapOptions();
    private bool overlay;
    private bool disabled => overlay || mapContainer == null;
    private MapLayerDef? layerDef;
    private IAzureMapContainer? mapContainer;
    private readonly GeolocationManager geolocationManager = new();
    private int? watchId;
    private bool isWatching => watchId != null;
    private bool isNotWatching => !isWatching;
    private bool disabledWatching => disabled || isWatching;
    private bool disabledNotWatching => disabled || isNotWatching;
    private bool disabledGetLocation => disabled || isWatching;

    private async Task OnCreatMapError(Exception ex)
    {
        ToastService.Error($"Error creating the map: {ex.Message}");
    }

    private async Task OnMapReady(IAzureMapContainer mapContainer)
    {
        try
        {
            await Task.CompletedTask;
            this.mapContainer = mapContainer;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.Error(ex);
        }
    }

    private async Task AddMapLayer(MapLayerType layerType)
    {
        try
        {
            if (mapContainer == null) return;

            overlay = true;

            await ResetMap();

            layerDef = await mapContainer.AddBasicMapLayer(DataService, layerType);
            ToastService.Info($"{layerType} layer added to the map.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.Error(ex);
        }
        finally
        {
            overlay = false;
        }
    }

    private async Task ResetMap()
    {
        try
        {
            if (mapContainer == null) return;

            await geolocationManager.RemoveLayers(mapContainer);

            if (layerDef != null)
            {
                await mapContainer.Layers.RemoveLayer(layerDef);
                layerDef = null;
            }

            await mapContainer.Configuration.SetMapOptions(options);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.Error(ex);
        }
    }

    private async Task GeolocationWatch(bool watch)
    {
        try
        {
            if (mapContainer == null) return;
            if (watch && isWatching) return;
            if (!watch && isNotWatching) return;

            if (watch)
            {
                await geolocationManager.Clear(mapContainer);
                watchId = await mapContainer.Maps.WatchGeolocation();
                ToastService.Info("Waiting for first Geolocation Watch event...");
            }
            else
            {
                if (watchId != null)
                {
                    await mapContainer.Maps.ClearWatchGeolocation(watchId.Value);
                    watchId = null;
                    await geolocationManager.Clear(mapContainer);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.Error(ex);
        }
    }

    private async Task OnGeolocationWatch(GeolocationEventArgs e)
    {
        ToastService.Info($"Geolocation Watch event received. Success:{e.GeolocationResult.IsSuccess}");
        if (e.GeolocationResult.IsSuccess)
        {
            await UpdateGeolocation(e.GeolocationResult);
        }
    }

    private async Task GetCurrentPosition()
    {
        try
        {
            if (mapContainer == null) return;

            overlay = true;

            var geolocation = await mapContainer.Maps.GetGeolocation(new PositionOptions { EnableHighAccuracy = true });

            if (geolocation != null)
            {
                if (geolocation.IsSuccess)
                {
                    await UpdateGeolocation(geolocation);
                }
                else
                {
                    var errMsg = $"Geolocation service failed. {geolocation.Error?.Message}";
                    Logger?.LogError(errMsg);
                    ToastService?.Error(errMsg);
                }
            }
            else
            {
                var warnMsg = $"Geolocation service returned null.";
                Logger?.LogWarning(warnMsg);
                ToastService?.Warning(warnMsg);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, null);
            ToastService.Error(ex);
        }
        finally
        {
            overlay = false;
        }
    }

    private async Task UpdateGeolocation(GeolocationResult geolocation)
    {
        if (mapContainer == null) return;

        var coordinates = geolocation.Position!.Coords!;
        var position = new Position(coordinates.Longitude, coordinates.Latitude) { Accuracy = geolocation.Position.Coords?.Accuracy };
        if (!geolocationManager.LayersAdded)
            await geolocationManager.AddLayers(mapContainer);
        await geolocationManager.Clear(mapContainer);
        await geolocationManager.AddPosition(mapContainer, position);
        await mapContainer.Configuration.ZoomTo(position, 15);
    }
}
